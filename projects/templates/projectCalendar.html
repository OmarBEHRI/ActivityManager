{% extends "projectDetailsBase.html" %}

{% block extra_styles %}
<style>
.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.5rem;
    padding: 0.5rem;
    background-color: var(--bg-white);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px var(--shadow-light);
}
.calendar-day-header {
    font-weight: 600;
    color: var(--text-color-medium);
    text-align: center;
    padding: 0.5rem 0;
}
.calendar-cell {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 80px;
    border-radius: 0.375rem;
    background-color: var(--bg-light);
    border: 1px solid var(--border-color);
    padding: 0.5rem;
    position: relative;
}
.calendar-cell.inactive {
    background-color: var(--bg-light);
    color: var(--text-color-light);
    cursor: not-allowed;
}
.calendar-cell.today {
    background-color: var(--primary-color);
    color: var(--bg-white);
    font-weight: 700;
}
.calendar-date {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--dark-text);
}
.event-badge {
    position: absolute;
    bottom: 0.25rem;
    left: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--bg-white);
    text-align: center;
    white-space: nowrap;
}
.event-badge.inprogress {
    background-color: var(--primary-color);
}
.event-badge.completed {
    background-color: #4CAF50;
}
.event-badge.planned {
    background-color: #2196F3;
}
</style>
{% endblock %}

{% block content %}
<div class="section-card">
  <div class="flex justify-between items-center mb-4">
    <button id="prevMonthCalendrier" class="px-3 py-1 rounded-md bg-[var(--button-bg-light)] text-[var(--nav-link-color)] hover:bg-gray-200">◀</button>
    <h3 id="currentMonthYearCalendrier" class="text-xl font-semibold text-[var(--dark-text)]">Mois Année</h3>
    <button id="nextMonthCalendrier" class="px-3 py-1 rounded-md bg-[var(--button-bg-light)] text-[var(--nav-link-color)] hover:bg-gray-200">▶</button>
  </div>
  <div class="calendar-grid" id="calendarGridCalendrier">
    <div class="calendar-day-header">Lun</div>
    <div class="calendar-day-header">Mar</div>
    <div class="calendar-day-header">Mer</div>
    <div class="calendar-day-header">Jeu</div>
    <div class="calendar-day-header">Ven</div>
    <div class="calendar-day-header">Sam</div>
    <div class="calendar-day-header">Dim</div>
    <!-- Calendar cells will be generated by JS -->
  </div>
</div>



<script>
document.addEventListener('DOMContentLoaded', () => {
  // Calendrier Tab Calendar
  const calendarGridCalendrier = document.getElementById('calendarGridCalendrier');
  const currentMonthYearCalendrier = document.getElementById('currentMonthYearCalendrier');
  const prevMonthBtnCalendrier = document.getElementById('prevMonthCalendrier');
  const nextMonthBtnCalendrier = document.getElementById('nextMonthCalendrier');
  
  // Initialize with server-provided data
  let currentMonth = {{ current_month }};
  let currentYear = {{ current_year }};
  let currentDateCalendrier = new Date(currentYear, currentMonth - 1, 1);
  
  // Store activities from the server
  const projectActivities = [
    {% for activity in calendar_activities %}
      {
        id: {{ activity.id }},
        title: "{{ activity.title|escapejs }}",
        description: "{{ activity.description|escapejs }}",
        startDate: new Date("{{ activity.start_date|date:'Y-m-d' }}"),
        endDate: new Date("{{ activity.end_date|date:'Y-m-d' }}"),
        employee: "{{ activity.employee|escapejs }}",
        charge: {{ activity.charge }}
      },
    {% endfor %}
  ];
  
  // Update the calendar title
  currentMonthYearCalendrier.textContent = `{{ month_name }} ${currentYear}`;
  
  // Function to render the calendar
  function renderCalendar() {
    // Clear previous calendar cells
    const dayHeaders = calendarGridCalendrier.querySelectorAll('.calendar-day-header');
    const cells = calendarGridCalendrier.querySelectorAll('.calendar-cell');
    cells.forEach(cell => cell.remove());
    
    // Get first day of month and total days
    const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
    // Convert Sunday (0) to 7 to match Monday (1) start
    const firstDayAdjusted = firstDay === 0 ? 7 : firstDay;
    const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
    
    // Add empty cells for days before the first day of month
    for (let i = 1; i < firstDayAdjusted; i++) {
      const emptyCell = document.createElement('div');
      emptyCell.className = 'calendar-cell inactive';
      calendarGridCalendrier.appendChild(emptyCell);
    }
    
    // Add cells for each day of the month
    const today = new Date();
    for (let day = 1; day <= daysInMonth; day++) {
      const cell = document.createElement('div');
      cell.className = 'calendar-cell';
      
      // Check if this is today
      if (day === today.getDate() && currentMonth === today.getMonth() + 1 && currentYear === today.getFullYear()) {
        cell.classList.add('today');
      }
      
      // Add date to cell
      const dateSpan = document.createElement('span');
      dateSpan.className = 'calendar-date';
      dateSpan.textContent = day;
      cell.appendChild(dateSpan);
      
      // Check for activities on this day
      const cellDate = new Date(currentYear, currentMonth - 1, day);
      const activitiesOnDay = projectActivities.filter(activity => {
        const activityDate = new Date(activity.startDate);
        return activityDate.getDate() === day && 
               activityDate.getMonth() === currentMonth - 1 && 
               activityDate.getFullYear() === currentYear;
      });
      
      // Add activity badges if there are activities
      if (activitiesOnDay.length > 0) {
        const badge = document.createElement('div');
        badge.className = 'event-badge inprogress';
        badge.textContent = activitiesOnDay.length > 1 ? `${activitiesOnDay.length} activités` : '1 activité';
        cell.appendChild(badge);
        
        // Add tooltip with activity details
        cell.title = activitiesOnDay.map(act => `${act.title} (${act.employee})`).join('\n');
        
        // Make cell clickable to show details
        cell.style.cursor = 'pointer';
        cell.addEventListener('click', () => {
          alert(`Activités du ${day}/${currentMonth}/${currentYear}:\n\n` + 
                activitiesOnDay.map(act => `- ${act.title}\n  Par: ${act.employee}\n  Charge: ${act.charge} heures`).join('\n\n'));
        });
      }
      
      calendarGridCalendrier.appendChild(cell);
    }
  }
  
  // Initial render
  renderCalendar();
  
  // Handle month navigation
  prevMonthBtnCalendrier.addEventListener('click', () => {
    currentMonth--;
    if (currentMonth < 1) {
      currentMonth = 12;
      currentYear--;
    }
    currentDateCalendrier = new Date(currentYear, currentMonth - 1, 1);
    currentMonthYearCalendrier.textContent = `${currentDateCalendrier.toLocaleString('fr-FR', { month: 'long' })} ${currentYear}`;
    renderCalendar();
  });
  
  nextMonthBtnCalendrier.addEventListener('click', () => {
    currentMonth++;
    if (currentMonth > 12) {
      currentMonth = 1;
      currentYear++;
    }
    currentDateCalendrier = new Date(currentYear, currentMonth - 1, 1);
    currentMonthYearCalendrier.textContent = `${currentDateCalendrier.toLocaleString('fr-FR', { month: 'long' })} ${currentYear}`;
    renderCalendar();
  });
  // End of calendar initialization
});
</script>

{% endblock %}

{% block active_tab %}showTab('calendrier');{% endblock %}

{% block extra_scripts %}
<style>
  /* Add more space at the bottom of the calendar */
  #calendarGridCalendrier {
    margin-bottom: 60px;
  }
</style>
{% endblock %}